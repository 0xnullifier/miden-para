## Mission

- Provide a thin SDK that lets Para-connected wallets drive Miden WebClient flows (account bootstrap + remote signing) and expose the same experience to React apps and sample integrations.
- Keep the TypeScript sources framework‑agnostic in `src/`, then layer ergonomics (`useParaMiden`) and runnable demos (`examples/react`) on top.

## Repo Surface Map

- **Root package (`miden-para`)** — exports `createParaMidenClient`, low-level helpers (`signCb`, modal helpers, key/seed utilities) and type definitions. Builds ship as dual CJS/ESM bundles generated by `scripts/build.mjs`.
- **React hook (`packages/use-miden-para-react`)** — `useParaMiden` watches Para React SDK state, instantiates `createParaMidenClient`, and hands back `{ client, accountId, para, evmWallets }` for UI code.
- **Example app (`examples/react`)** — Vite + React starter that wires `ParaProvider`, the hook, and a `ConsumeAllNotes` component showing how to sync, fetch, and consume notes against `https://rpc.testnet.miden.io`.
- **Tests (`tests/`)** — Node’s built-in test runner validates the DOM modals by transpiling `src/modalClient.ts` on the fly.

## Build, Test, Publish

- Install deps with `yarn install` (Yarn 1.22.22 is pinned).
- Root build: `yarn build` → runs esbuild per-format + `tsc` for d.ts generation. Outputs land in `dist/{esm,cjs,types}`.
- React hook build: `cd packages/use-miden-para-react && yarn build` (tsup).
- Tests: `yarn test` (root). Example app: `cd examples/react && yarn dev`.
- Packing/publishing: `npm run publish` (root) invokes `prepack`/`postpack`, moving `miden-para-<version>.tgz` into `build/`.

## Key Flows & Files

1. **Para + Miden bootstrap (`src/midenClient.ts`)**
   - `createParaMidenClient(para, wallets, opts)` filters wallet list to EVM entries, fetches uncompressed public keys (`getUncompressedPublicKeyFromWallet`), and lets the user choose one (`accountSelectionModal`).
   - It calls the SDK’s `WebClient.createClientWithExternalKeystore`, injecting `signCb` to pipe signing prompts through Para’s `signMessage`.
   - `createAccount` guarantees a Miden account exists for the chosen wallet using commitment data derived via `evmPkToCommitment`.
2. **Modal UX (`src/modalClient.ts`)**
   - Minimal DOM-only overlay + buttons, pure TypeScript, friendly to SSR (guards on `typeof document`).
   - Dedicated tests (`tests/modalClient.test.cjs`) assert rendering, resolution semantics, and cleanup.
3. **React integration (`packages/use-miden-para-react/src/useParaMiden.ts`)**
   - Leverages `useClient`, `useAccount`, `useWallet` (Para React SDK) to watch connection state.
   - Lazily imports `@demox-labs/miden-sdk` for `AccountType`, spins up the Para-backed WebClient once wallets resolve, and memoizes the resulting client in a ref.
   - Imports the root npm package (`miden-para`).
4. **Example consumer (`examples/react/src/components/ConsumeAllNotes.tsx`)**
   - Wraps UI with `ParaProvider` + TanStack Query.
   - Demonstrates wallet connect UX, syncing the client, fetching consumable notes, and submitting a consume transaction.
   - Includes browser polyfills for `Buffer`/`process` (`examples/react/src/polyfills.ts`) so the SDK can run in Vite.
   - Imports both the root npm package (`miden-para`) and the react integration (`packages/use-mien-para-react`).

## Agent Playbooks

- **Adding core features**: work inside `src/`; export via `src/index.ts`. Run `yarn build` + `yarn test`. Keep browser safety in mind (no Node globals, guard for `window`).
- **Tweaking the hook**: edit `packages/use-miden-para-react/src/useParaMiden.ts`, ensure types remain framework-agnostic (only React in this package). Update README + bump version when API changes.
- **Improving UX**: adjust modal styling/text in `src/modalClient.ts` and extend tests to pin desired behavior. Ensure no external CSS dependencies.
- **Example updates**: treat `examples/react` as a playground; document new flows in its README so developers can replicate steps in their apps.

## External Contracts

- Para Web/React SDKs (`@getpara/web-sdk`, `@getpara/react-sdk`) — provide wallet discovery, JWT issuance, and signing.
- Miden SDK (`@demox-labs/miden-sdk`) — supplies `WebClient`, account builders, Felt/RPO utilities, and transaction helpers.
- Noble hashes (`@noble/hashes`) — used for keccak hashing + hex conversions during signing.

Keep peer dependency versions aligned with `package.json` to avoid duplicated SDK copies inside consuming apps.
